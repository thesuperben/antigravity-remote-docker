; =============================================================================
; Antigravity Docker - Supervisor Configuration
; =============================================================================
; Manages all container services: VNC, noVNC, SSH, and auto-updates
; =============================================================================

[supervisord]
nodaemon=true
logfile=/tmp/supervisord.log
pidfile=/tmp/supervisord.pid
childlogdir=/tmp
logfile_maxbytes=50MB
logfile_backups=3
loglevel=info

; =============================================================================
; SSH Server (Required for Git & VS Code Remote)
; =============================================================================
[program:sshd]
command=/usr/sbin/sshd -D
user=root
autostart=true
autorestart=true
priority=5
startsecs=0
stdout_logfile=/tmp/sshd-stdout.log
stderr_logfile=/tmp/sshd-stderr.log
stdout_logfile_maxbytes=5MB
stderr_logfile_maxbytes=5MB

; =============================================================================
; VNC Server
; =============================================================================
[program:vnc]
command=/opt/scripts/start-vnc.sh
user=antigravity
environment=HOME="/home/antigravity",USER="antigravity",DISPLAY=":1"
autostart=true
autorestart=true
priority=10
startsecs=5
startretries=3
stdout_logfile=/tmp/vnc-stdout.log
stderr_logfile=/tmp/vnc-stderr.log
stdout_logfile_maxbytes=10MB
stderr_logfile_maxbytes=10MB

; =============================================================================
; noVNC Web Server
; =============================================================================
[program:novnc]
command=/opt/scripts/start-novnc.sh
user=antigravity
environment=HOME="/home/antigravity",USER="antigravity"
autostart=true
autorestart=true
priority=20
startsecs=10
startretries=3
stdout_logfile=/tmp/novnc-stdout.log
stderr_logfile=/tmp/novnc-stderr.log
stdout_logfile_maxbytes=10MB
stderr_logfile_maxbytes=10MB

; =============================================================================
; Daily Update Check (runs once per day)
; =============================================================================
[program:update-cron]
command=/bin/bash -c "while true; do sleep 86400; /opt/scripts/update-antigravity.sh; done"
autostart=true
autorestart=true
priority=100
startsecs=0
stdout_logfile=/tmp/update-stdout.log
stderr_logfile=/tmp/update-stderr.log
stdout_logfile_maxbytes=5MB
stderr_logfile_maxbytes=5MB

; =============================================================================
; Idle Monitor (reduces resources when no client connected)
; =============================================================================
[program:idle-monitor]
command=/opt/scripts/idle-monitor.sh
user=antigravity
environment=HOME="/home/antigravity",USER="antigravity",DISPLAY=":1"
autostart=true
autorestart=true
priority=50
startsecs=5
stdout_logfile=/tmp/idle-monitor-stdout.log
stderr_logfile=/tmp/idle-monitor-stderr.log
stdout_logfile_maxbytes=5MB
stderr_logfile_maxbytes=5MB

; =============================================================================
; Auto-start Antigravity (launches after desktop is ready)
; =============================================================================
[program:autostart-antigravity]
command=/bin/bash -c "sleep 8 && DISPLAY=:1 antigravity"
user=antigravity
environment=HOME="/home/antigravity",USER="antigravity",DISPLAY=":1"
autostart=true
autorestart=false
priority=90
startsecs=0
stdout_logfile=/tmp/antigravity-stdout.log
stderr_logfile=/tmp/antigravity-stderr.log
stdout_logfile_maxbytes=10MB
stderr_logfile_maxbytes=10MB

; =============================================================================
; Process Groups
; =============================================================================
[group:desktop]
programs=vnc,novnc,idle-monitor
priority=10

[group:apps]
programs=autostart-antigravity
priority=50

[group:maintenance]
programs=update-cron
priority=100
